name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    name: Build (${{ matrix.platform }})
    strategy:
      matrix:
        include:
          - os: macos-15
            platform: macos
            archive-name: clai-macos
          - os: ubuntu-latest
            platform: linux-x64
            build-path: x86_64-unknown-linux-gnu/release
            archive-name: clai-linux-x64
            container: swift:6.1

    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    steps:
      - uses: actions/checkout@v5

      - name: Select Xcode 16.4 (macOS)
        if: matrix.platform == 'macos'
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Install mise (macOS)
        if: matrix.platform == 'macos'
        uses: jdx/mise-action@v2

      - name: Cache SPM dependencies (macOS)
        if: matrix.platform == 'macos'
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Cache SPM dependencies (Linux)
        if: matrix.platform == 'linux-x64'
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-linux-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-linux-spm-

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          FILE="Sources/clai/Clai.swift"
          if [ "${{ matrix.platform }}" = "macos" ]; then
            sed -i '' "s/version: \".*\"/version: \"$VERSION\"/" "$FILE"
          else
            sed -i "s/version: \".*\"/version: \"$VERSION\"/" "$FILE"
          fi

      - name: Build release binary (macOS)
        if: matrix.platform == 'macos'
        run: |
          xcodebuild -scheme clai -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath .build/xcode \
            -skipMacroValidation \
            build 2>&1 | xcsift -w -f toon --toon-key-folding safe

      - name: Build release binary (Linux)
        if: matrix.platform == 'linux-x64'
        run: swift build -c release --static-swift-stdlib

      - name: Create release archive (macOS)
        if: matrix.platform == 'macos'
        run: |
          mkdir -p dist
          cp .build/xcode/Build/Products/Release/clai dist/clai
          # Copy MLX metallib for local inference support (colocated with binary)
          cp .build/xcode/Build/Products/Release/mlx-swift_Cmlx.bundle/Contents/Resources/default.metallib dist/mlx.metallib
          cp LICENSE dist/
          cd dist && zip -r ../${{ matrix.archive-name }}.zip .

      - name: Create release archive (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          mkdir -p dist
          cp .build/${{ matrix.build-path }}/clai dist/clai
          cp LICENSE dist/
          tar -czf ${{ matrix.archive-name }}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.archive-name }}
          path: |
            ${{ matrix.archive-name }}.zip
            ${{ matrix.archive-name }}.tar.gz
          if-no-files-found: ignore

  update-version:
    name: Update Version and Changelog
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version in main branch
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          FILE="Sources/clai/Clai.swift"
          sed -i "s/version: \".*\"/version: \"$VERSION\"/" "$FILE"

      - name: Update CHANGELOG.md
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --output CHANGELOG.md
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Sources/clai/Clai.swift CHANGELOG.md
          git diff --staged --quiet || git commit -m "chore(release): bump version to ${GITHUB_REF#refs/tags/v}"
          git push origin main

  release:
    name: Create Release
    needs: [build, update-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release notes
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          GITHUB_REPO: ${{ github.repository }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.content }}
          files: |
            artifacts/clai-macos/clai-macos.zip
            artifacts/clai-linux-x64/clai-linux-x64.tar.gz

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download release assets and calculate SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Download macOS release
          curl -sL "https://github.com/alexey1312/clai/releases/download/v${VERSION}/clai-macos.zip" -o clai-macos.zip
          MACOS_SHA=$(sha256sum clai-macos.zip | cut -d' ' -f1)
          echo "macos=${MACOS_SHA}" >> $GITHUB_OUTPUT

          # Download Linux release
          curl -sL "https://github.com/alexey1312/clai/releases/download/v${VERSION}/clai-linux-x64.tar.gz" -o clai-linux.tar.gz
          LINUX_SHA=$(sha256sum clai-linux.tar.gz | cut -d' ' -f1)
          echo "linux=${LINUX_SHA}" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew tap
        uses: actions/checkout@v5
        with:
          repository: alexey1312/homebrew-clai
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-clai

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          MACOS_SHA="${{ steps.sha.outputs.macos }}"
          LINUX_SHA="${{ steps.sha.outputs.linux }}"

          FORMULA="homebrew-clai/Formula/clai.rb"

          # Update version
          sed -i "s/version \".*\"/version \"${VERSION}\"/" "$FORMULA"

          # Update macOS SHA256 (first sha256 in the file)
          sed -i "0,/sha256 \"[a-f0-9]*\"/s//sha256 \"${MACOS_SHA}\"/" "$FORMULA"

          # Update Linux SHA256 (second sha256 in the file)
          sed -i "0,/sha256 \"${MACOS_SHA}\"/! {0,/sha256 \"[a-f0-9]*\"/s//sha256 \"${LINUX_SHA}\"/}" "$FORMULA"

          cat "$FORMULA"

      - name: Commit and push
        working-directory: homebrew-clai
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/clai.rb
          git diff --staged --quiet || git commit -m "chore: bump to v${{ steps.version.outputs.version }}"
          git push
